(global["webpackJsonp"]=global["webpackJsonp"]||[]).push([["common/main"],{"2c83":function(e,t,s){"use strict";s("859d");var o=i(s("f3d3")),n=i(s("ed8f")),a=i(s("e233")),r=i(s("9778"));function i(e){return e&&e.__esModule?e:{default:e}}function u(e){for(var t=1;t<arguments.length;t++){var s=null!=arguments[t]?arguments[t]:{},o=Object.keys(s);"function"===typeof Object.getOwnPropertySymbols&&(o=o.concat(Object.getOwnPropertySymbols(s).filter(function(e){return Object.getOwnPropertyDescriptor(s,e).enumerable}))),o.forEach(function(t){c(e,t,s[t])})}return e}function c(e,t,s){return t in e?Object.defineProperty(e,t,{value:s,enumerable:!0,configurable:!0,writable:!0}):e[t]=s,e}o.default.config.productionTip=!1,o.default.prototype.GLOBAL=a.default,o.default.prototype.$store=r.default,n.default.mpType="app";var d=new o.default(u({store:r.default},n.default));d.$mount()},"3c04":function(e,t,s){"use strict";s.r(t);var o=s("e6b7"),n=s.n(o);for(var a in o)"default"!==a&&function(e){s.d(t,e,function(){return o[e]})}(a);t["default"]=n.a},"8cc7":function(e,t,s){},"8d42":function(e,t,s){"use strict";var o=s("8cc7"),n=s.n(o);n.a},9778:function(e,t,s){"use strict";(function(e){Object.defineProperty(t,"__esModule",{value:!0}),t.default=void 0;var o=r(s("f3d3")),n=r(s("2f62")),a=r(s("e233"));function r(e){return e&&e.__esModule?e:{default:e}}o.default.use(n.default);var i=new n.default.Store({state:{user:{hasLogin:!1,id:0,token:"",phone:"",avatar:"",password:"",userName:"",sex:0,merchant:0},school:{id:"11853391869743621792",title:"",addr:""},selectSchool:{id:"11853391869743621792",title:"",addr:""},msgList:[{id:69,to_id:67,avatar:"../../../static/logo.png",name:"to源哥",msg:"你是肥蛇吗？",status:"未读",unread:1},{id:67,to_id:69,avatar:"../../../static/logo.png",name:"to蛇皮",msg:"源哥最帅",status:"未读",unread:1},{id:111,to_id:70,avatar:"../../../static/logo.png",name:"狸猫",msg:"怎么说呢",status:"未读",unread:1}],unreadCount:3,historyMsg:{67:[{id:100,name:"历史",face:"https://staticimgs.oss-cn-beijing.aliyuncs.com/glogo.png",ctype:1,msg:"历史消息演示文本内容...",date:"2018 01-01 00:00"},{id:100,name:"历史",face:"https://staticimgs.oss-cn-beijing.aliyuncs.com/glogo.png",ctype:1,msg:"源哥最帅",date:"2018 01-01 00:00"}],69:[{id:100,name:"to蛇皮",face:"https://staticimgs.oss-cn-beijing.aliyuncs.com/glogo.png",ctype:1,msg:"历史消息演示文本内容...",date:"2018 01-01 00:00"}],70:[{id:100,name:"to蛇皮",face:"https://staticimgs.oss-cn-beijing.aliyuncs.com/glogo.png",ctype:1,msg:"怎么说呢",date:"2018 01-01 00:00"}]}},mutations:{regSetPhoneAndPass:function(e,t){e.user.phone=t.phone,e.user.password=t.password},regSetSex:function(e,t){e.user.sex=t},regSetSchool:function(e,t){e.school=t,e.selectSchool=t},regSetAvatar:function(e,t){e.user.avatar=t},regSetUserName:function(e,t){e.user.userName=t},regAfterLogin:function(e,t){e.user.id=t.user.user_id,e.user.phone=t.user.phone,e.user.sex=t.user.sex,e.user.userName=t.user.user_name,e.user.avatar=t.user.avatar,e.user.token=t.token,e.user.password="",e.user.hasLogin=!0,this.commit("loginAfterSetStorage")},login:function(e,t){e.user.id=t.user.user_id,e.user.phone=t.user.phone,e.user.sex=t.user.sex,e.user.userName=t.user.user_name,e.user.avatar=t.user.avatar,e.user.merchant=t.user.merchant,e.user.token=t.token,e.school=t.school,e.selectSchool=e.school,e.user.hasLogin=!0,this.commit("loginAfterSetStorage")},logOut:function(t){t.hasLogin=!1,e.clearStorage()},loginAfterSetStorage:function(t){e.setStorage({key:"user",data:t.user}),e.setStorage({key:"school",data:t.school}),e.setStorage({key:"selectSchool",data:t.selectSchool})},checkSchool:function(t,s){t.selectSchool=s,e.setStorage({key:"selectSchool",data:s,fail:function(){e.showModal({title:"提示",content:"学校切换失败！",showCancel:!1})}})},appOnLunch:function(t,s){t.user=s,t.school=e.getStorageSync("school"),t.selectSchool=e.getStorageSync("selectSchool"),e.setTabBarBadge({index:2,text:t.unreadCount.toString()})},onMessage:function(t){var s=this;e.onSocketOpen(function(o){console.log("WebSocket连接已打开！");var n={ctype:"init",id:t.user.id};e.sendSocketMessage({data:JSON.stringify(n)}),e.onSocketMessage(function(e){a.default.playMessage();var o=JSON.parse(e.data);console.log(JSON.stringify(o));var n=new Object;n.newMsg=o;var r="";switch(o.ctype){case 2:r="[图片]";break;case 3:r="[语音]";break;case 4:r="[系统通知]";break;default:r=o.msg}n.msgObj={id:t.user.id,to_id:o.id,avatar:o.face,name:o.name,msg:r,status:"未读",unread:1},s.commit("addMsg",n)})})},addMsg:function(t,s){for(var o=!1,n=0;n<t.msgList.length;n++)if(t.msgList[n].to_id===s.msgObj.to_id){o=!0;break}o?(t.historyMsg[s.newMsg.id].push(s.newMsg),t.msgList[n].msg=s.msgObj.msg,t.msgList[n].unread+=1):(t.historyMsg[s.newMsg.to_id]=[],t.historyMsg[s.newMsg.to_id].push(s.newMsg),t.msgList.unshift(s.msgObj)),e.setTabBarBadge({index:2,text:t.unreadCount.toString()}),this.commit("setMsgStorage")},sendMsg:function(t,s){e.sendSocketMessage({data:JSON.stringify(s)});for(var o=!1,n=0;n<t.msgList.length;n++)if(t.msgList[n].to_id==s.to_id){o=!0;break}var a="";switch(s.ctype){case 2:a="[图片]";break;case 3:a="[语音]";break;case 4:a="[系统通知]";break;default:a=s.msg}if(o)t.historyMsg[s.to_id].push(s),t.msgList[n].msg=a;else{var r={id:t.user.id,to_id:s.id,avatar:s.face,name:s.name,msg:a,status:"已读",unread:0};t.historyMsg[s.to_id]=[],t.historyMsg[s.to_id].push(s),t.msgList.unshift(r)}this.commit("setMsgStorage")},changeMsg:function(t,s){t.unreadCount-=t.msgList[s].unread,0!==t.unreadCount?e.setTabBarBadge({index:2,text:t.unreadCount.toString()}):e.removeTabBarBadge({index:2}),t.msgList[s].unread=0,t.msgList[s].status="已读",this.commit("setMsgStorage")},delMsg:function(e,t){e.msgList.splice(t,1),this.commit("setMsgStorage")},setMsgStorage:function(t){e.setStorage({key:"msgList",data:t.msgList}),e.setStorage({key:"historyMsg",data:t.historyMsg})},addGoods:function(e,t){}}}),u=i;t.default=u}).call(this,s("6e42")["default"])},a08b:function(e,t,s){"use strict";s.r(t);var o=s("c4ab"),n=s.n(o);for(var a in o)"default"!==a&&function(e){s.d(t,e,function(){return o[e]})}(a);t["default"]=n.a},c4ab:function(e,t,s){"use strict";(function(e){Object.defineProperty(t,"__esModule",{value:!0}),t.default=void 0;var s="ws://118.24.124.19:8282",o="https://apii.ym998.cn/",n={serverSrc:o,serverChat:s,requestFail:function(t){0===t.statusCode?e.showToast({title:"网络错误, 请确保设备处在联网状态",icon:"none"}):e.showToast({title:"发生网络错误啦！错误码："+t.statusCode,icon:"none"})},tokenFail:function(){e.showToast({title:"身份验证失效，请重新登录！",icon:"none"}),e.removeStorage({key:"user"}),e.removeStorage({key:"market"}),e.redirectTo({url:"/pages/common/login"})},checkUpdater:function(t,s){e.request({url:o+"common/check_update/update",method:"GET",success:function(o){200===o.statusCode&&t!=o.data.version&&e.showModal({title:"发现新版本",content:"有新版本可用，请问您是否更新？",success:function(t){t.confirm&&e.navigateTo({url:s})}})}})},playMessage:function(){var t=e.createInnerAudioContext();t.autoplay=!0,t.src=this.serverSrc+"static/music/message.mp3",t.onPlay(function(){}),t.onError(function(e){console.log(e.errMsg),console.log(e.errCode)})}};t.default=n}).call(this,s("6e42")["default"])},e233:function(e,t,s){"use strict";s.r(t);var o=s("e8fb"),n=s("a08b");for(var a in n)"default"!==a&&function(e){s.d(t,e,function(){return n[e]})}(a);var r=s("2877"),i=Object(r["a"])(n["default"],o["a"],o["b"],!1,null,null,null);t["default"]=i.exports},e6b7:function(e,t,s){"use strict";(function(e){Object.defineProperty(t,"__esModule",{value:!0}),t.default=void 0;var o=s("2f62");function n(e){for(var t=1;t<arguments.length;t++){var s=null!=arguments[t]?arguments[t]:{},o=Object.keys(s);"function"===typeof Object.getOwnPropertySymbols&&(o=o.concat(Object.getOwnPropertySymbols(s).filter(function(e){return Object.getOwnPropertyDescriptor(s,e).enumerable}))),o.forEach(function(t){a(e,t,s[t])})}return e}function a(e,t,s){return t in e?Object.defineProperty(e,t,{value:s,enumerable:!0,configurable:!0,writable:!0}):e[t]=s,e}var r={computed:(0,o.mapState)(["msgList"]),methods:n({},(0,o.mapMutations)(["appOnLunch","addMsg","onMessage"])),onLaunch:function(){var t=e.getStorageSync("user");!0===t.hasLogin&&(this.appOnLunch(t),e.connectSocket({url:this.GLOBAL.serverChat}),this.onMessage());var s=e.getStorageSync("updated");!0===s.completed&&e.removeSavedFile({filePath:s.packgePath,success:function(t){e.removeStorageSync("updated")}}),this.GLOBAL.checkUpdater(plus.runtime.version,"../common/update")},onShow:function(){e.showModal({title:"提示",content:"此版本为源梦团队内部测试版本，未经允许禁止发布到互联网！www.ym998.cn",showCancel:!1})},onHide:function(){e.connectSocket({url:this.GLOBAL.serverChat}),this.onMessage(),e.request({url:this.GLOBAL.serverSrc+"message/top_chat/recordlist",method:"POST",data:{msgList:this.msgList}}),console.log("App Hide")}};t.default=r}).call(this,s("6e42")["default"])},e8fb:function(e,t,s){"use strict";var o=function(){var e=this,t=e.$createElement,s=e._self._c||t;return s("view")},n=[];s.d(t,"a",function(){return o}),s.d(t,"b",function(){return n})},ed8f:function(e,t,s){"use strict";s.r(t);var o=s("3c04");for(var n in o)"default"!==n&&function(e){s.d(t,e,function(){return o[e]})}(n);s("8d42");var a,r,i=s("2877"),u=Object(i["a"])(o["default"],a,r,!1,null,null,null);t["default"]=u.exports}},[["2c83","common/runtime","common/vendor"]]]);